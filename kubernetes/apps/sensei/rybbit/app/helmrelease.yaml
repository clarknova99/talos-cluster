---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app rybbit
  namespace: sensei
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 4.6.2
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      interval: 15m
  maxHistory: 3
  install:
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    controllers:
      rybbit:
        replicas: 1
        containers:
          backend:
            image:
              repository: ghcr.io/rybbit-io/rybbit-backend
              tag: v2.4.0
            env:
              NODE_ENV: production
              CLICKHOUSE_HOST: http://rybbit-clickhouse.sensei.svc.cluster.local:8123
              CLICKHOUSE_DB: analytics
              CLICKHOUSE_USER: default
              CLICKHOUSE_PASSWORD: ${SECRET_CLICKHOUSE_PASSWORD}
              POSTGRES_HOST: postgres-lb-vector.database.svc.cluster.local
              POSTGRES_PORT: 5432
              POSTGRES_DB: rybbit
              POSTGRES_USER: ${SECRET_PGADMIN_USER}
              POSTGRES_PASSWORD: ${SECRET_PGADMIN_PASSWORD}
              BETTER_AUTH_SECRET: ${SECRET_RYBBIT_BETTER_AUTH_SECRET}
              BASE_URL: https://rybbit.${SECRET_DOMAIN_TWO}
              DISABLE_SIGNUP: false
          client:
            image:
              repository: ghcr.io/rybbit-io/rybbit-client
              tag: v2.4.0
            env:
              NODE_ENV: production
              NEXT_PUBLIC_BACKEND_URL: https://rybbit-backend.${SECRET_DOMAIN_TWO}
              NEXT_PUBLIC_DISABLE_SIGNUP: false
              BETTER_AUTH_SECRET: ${SECRET_RYBBIT_BETTER_AUTH_SECRET}
          # clickhouse:
          #   image:
          #     repository: clickhouse/clickhouse-server
          #     tag: 25.12-alpine
          #   env:
          #     CLICKHOUSE_DB: analytics
          #     CLICKHOUSE_USER: default
          #     CLICKHOUSE_PASSWORD: ${SECRET_CLICKHOUSE_PASSWORD}
          #     CLICKHOUSE_DO_NOT_CHOWN: "1"
    service:
      backend:
        controller: rybbit
        ports:
          http:
            port: 3001
      client:
        controller: rybbit
        ports:
          http:
            port: 3002
      # clickhouse:
      #   controller: rybbit
      #   type: LoadBalancer
      #   annotations:
      #     io.cilium/lb-ipam-ips: 192.168.3.83
      #   ports:
      #     http:
      #       port: 8123
      #     tcp:
      #       port: 9000

    # persistence:
    #   data:
    #     enabled: true
    #     type: nfs
    #     server: 192.168.1.3
    #     path: /volume1/network-storage/cluster/rybbit/clickhouse
    #     advancedMounts:
    #       rybbit:
    #         clickhouse:
    #           - path: /var/lib/clickhouse
    #   tmp:
    #     enabled: true
    #     type: emptyDir
    #     medium: Memory
    #     advancedMounts:
    #       rybbit:
    #         clickhouse:
    #           - path: /tmp
    #   logs:
    #     enabled: true
    #     type: emptyDir
    #     advancedMounts:
    #       rybbit:
    #         clickhouse:
    #           - path: /var/log/clickhouse-server

    route:
      main:
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/group: "Sensei Services"
          gethomepage.dev/icon: https://rybbit.com/rybbit-text.svg
        parentRefs:
          - name: envoy-external
            namespace: network
            sectionName: https
        hostnames:
          - rybbit.${SECRET_DOMAIN_TWO}
        rules:
          - matches:
            - path:
                type: PathPrefix
                value: /api
            backendRefs:
              - kind: Service
                name: rybbit-backend
                port: 3001
            filters:
              - type: ResponseHeaderModifier
                responseHeaderModifier:
                  add:
                    - name: Cross-Origin-Resource-Policy
                      value: cross-origin
          - matches:
            - path:
                type: PathPrefix
                value: /
            backendRefs:
              - kind: Service
                name: rybbit-client
                port: 3002
            filters:
              - type: ResponseHeaderModifier
                responseHeaderModifier:
                  add:
                    - name: Cross-Origin-Resource-Policy
                      value: cross-origin

    # ingress:
    #   client:
    #     annotations:
    #       external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN_TWO}"
    #       nginx.ingress.kubernetes.io/enable-cors: "true"
    #       nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    #       nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    #       hajimari.io/enable: "true"
    #       hajimari.io/icon: mdi:math-compass
    #     className: external
    #     enabled: true
    #     hosts:
    #       - host: rybbit.${SECRET_DOMAIN_TWO}
    #         paths:
    #           - path: /api
    #             service:
    #               identifier: backend
    #               port: 3001
    #           - path: /
    #             service:
    #               identifier: client
    #               port: 3002
    #     tls:
    #       - hosts:
    #           - rybbit.${SECRET_DOMAIN_TWO}
