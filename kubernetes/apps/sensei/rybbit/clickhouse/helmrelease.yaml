---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: rybbit-clickhouse
  namespace: sensei
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      interval: 15m
  maxHistory: 2
  install:
    remediation:
      retries: 10
  upgrade:
    remediation:
      retries: 10
  values:
    controllers:
      rybbit-clickhouse:
        containers:
          app:
            image:
              repository: clickhouse/clickhouse-server
              tag: 25.12-alpine
            env:
              CLICKHOUSE_DB: analytics
              CLICKHOUSE_USER: default
              CLICKHOUSE_PASSWORD: ${SECRET_CLICKHOUSE_PASSWORD}
              CLICKHOUSE_DO_NOT_CHOWN: "1"
          clickhouse-backup:
            image:
              repository: altinity/clickhouse-backup
              tag: 2.6.41
            # - server for API triggered backups, - watch for scheduled backups
            command:
              - /bin/clickhouse-backup
              - watch

            env:
              LOG_LEVEL: "info"
              ALLOW_EMPTY_BACKUPS: "true"
              API_LISTEN: "0.0.0.0:7171"
              BACKUPS_TO_KEEP_LOCAL: "0"
              BACKUPS_TO_KEEP_REMOTE: "30"
              CLICKHOUSE_SKIP_TABLES: "system.*,INFORMATION_SCHEMA.*"
              CLICKHOUSE_USERNAME: dittofeed
              CLICKHOUSE_PASSWORD: ${SECRET_CLICKHOUSE_PASSWORD}
              CLICKHOUSE_HOST: "127.0.0.1"  # Use IPv4 explicitly
              CLICKHOUSE_PORT: "9000"

              WATCH_INTERVAL: "4h"  # Create backup every 24 hours
              FULL_INTERVAL: "24h"  # Full backup every day


              # AWS S3 Configuration
              REMOTE_STORAGE: s3
              S3_BUCKET: "dittofeed-backup"  # Your S3 bucket name
              S3_ACCESS_KEY: "${SECRET_SENSEI_AWS_ACCESS_KEY_ID}"  # AWS Access Key ID
              S3_SECRET_KEY: "${SECRET_SENSEI_AWS_SECRET_ACCESS_KEY}"  # AWS Secret Access Key
              S3_REGION: "${SECRET_SENSEI_AWS_S3_REGION}"  # AWS region (e.g., us-east-1)
              S3_ENDPOINT: ""  # Leave empty for AWS S3 (uses default AWS endpoints)
              S3_PATH: "rybbit/clickhouse/"  # Optional: prefix path in bucket
              S3_DISABLE_SSL: "false"  # Use HTTPS for AWS S3
              S3_FORCE_PATH_STYLE: "false"  # Use virtual-hosted-style for AWS S3

            ports:
              - name: backup-api
                containerPort: 7171
    service:
      app:
        controller: rybbit-clickhouse
        type: LoadBalancer
        annotations:
          io.cilium/lb-ipam-ips: 192.168.3.83
        ports:
          http:
            port: 8123
          tcp:
            port: 9000
    persistence:
      data:
        enabled: true
        type: nfs
        server: 192.168.1.3
        path: /volume1/network-storage/cluster/rybbit/clickhouse
        globalMounts:
          - path: /var/lib/clickhouse
        advancedMounts:

          rybbit:
            clickhouse:
              - path: /var/lib/clickhouse

    # persistence:
    #   data:
    #     enabled: true
    #     type: nfs
    #     server: 192.168.1.3
    #     path: /volume1/network-storage/cluster/dittofeed-dev/clickhouse
    #     globalMounts:
    #       - path: /var/lib/clickhouse
        # advancedMounts:
        #   dittofeed-dev-clickhouse:
        #     app:
        #       - path: /var/lib/clickhouse
      # # Add new NFS volume for backups
      # backups:
      #   enabled: true
      #   type: nfs
      #   server: 192.168.1.3
      #   path: /volume1/network-storage/cluster/dittofeed-dev/clickhouse-backups
      #   globalMounts:
      #     - path: /var/lib/clickhouse/backup
