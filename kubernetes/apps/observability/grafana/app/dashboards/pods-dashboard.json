{
  "type": "table",
  "title": "Pods",
  "datasource": {
    "type": "prometheus",
    "uid": "prometheus"
  },
  "targets": [
    {
      "refId": "INFO",
      "format": "table",
      "instant": true,
      "expr": "max by (namespace, pod, node, pod_ip) (kube_pod_info{namespace=~\"$namespace\"})"
    },
    {
      "refId": "OWNER",
      "format": "table",
      "instant": true,
      "expr": "max by (namespace, pod, owner_kind) (kube_pod_owner{namespace=~\"$namespace\"})"
    },
    {
      "refId": "CPU",
      "format": "table",
      "instant": true,
      "expr": "sum by (namespace, pod) (rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\",container!=\"\",image!=\"\"}[5m]))"
    },
    {
      "refId": "MEM",
      "format": "table",
      "instant": true,
      "expr": "sum by (namespace, pod) (container_memory_working_set_bytes{namespace=~\"$namespace\",container!=\"\",image!=\"\"})"
    },
    {
      "refId": "RESTARTS",
      "format": "table",
      "instant": true,
      "expr": "sum by (namespace, pod) (kube_pod_container_status_restarts_total{namespace=~\"$namespace\"})"
    },
    {
      "refId": "PHASE",
      "format": "table",
      "instant": true,
      "expr": "max by (namespace, pod, phase) (kube_pod_status_phase{namespace=~\"$namespace\",phase=~\"$status\"} == 1)"
    },

    {
      "refId": "CBOX",
      "format": "table",
      "instant": true,
      "expr": "(\n  max by (namespace,pod,cbox) (\n    label_replace(kube_pod_container_status_ready{namespace=~\"$namespace\"}==1, \"cbox\", \"ðŸŸ© $1\", \"container\", \"(.*)\")\n  )\n)\nOR\n(\n  max by (namespace,pod,cbox) (\n    label_replace(kube_pod_container_status_waiting{namespace=~\"$namespace\"}==1, \"cbox\", \"ðŸŸ§ $1\", \"container\", \"(.*)\")\n  )\n)\nOR\n(\n  max by (namespace,pod,cbox) (\n    label_replace(kube_pod_container_status_terminated{namespace=~\"$namespace\"}==1, \"cbox\", \"ðŸŸ¥ $1\", \"container\", \"(.*)\")\n  )\n)"
    }
  ],
  "transformations": [
    {
      "id": "labelsToFields",
      "options": {}
    },
    {
      "id": "calculateField",
      "options": {
        "alias": "pod_key",
        "mode": "reduceRow",
        "reduce": { "reducer": "lastNotNull" },
        "replaceFields": false
      }
    },
    {
      "id": "addFieldFromCalculation",
      "options": {
        "mode": "binary",
        "binary": {
          "left": "namespace",
          "operator": "+",
          "right": "pod"
        },
        "alias": "pod_key",
        "replaceFields": true
      }
    },
    {
      "id": "joinByField",
      "options": {
        "byField": "pod_key",
        "mode": "outer"
      }
    },
    {
      "id": "groupBy",
      "options": {
        "fields": {
          "namespace": true,
          "pod": true
        },
        "aggregations": [
          { "fieldName": "node", "reducer": "lastNotNull", "alias": "Node" },
          { "fieldName": "pod_ip", "reducer": "lastNotNull", "alias": "Pod IP" },
          { "fieldName": "owner_kind", "reducer": "lastNotNull", "alias": "Controlled By" },
          { "fieldName": "Value #CPU", "reducer": "lastNotNull", "alias": "CPU (cores)" },
          { "fieldName": "Value #MEM", "reducer": "lastNotNull", "alias": "Memory" },
          { "fieldName": "Value #RESTARTS", "reducer": "lastNotNull", "alias": "Restarts" },
          { "fieldName": "phase", "reducer": "lastNotNull", "alias": "Status" },
          { "fieldName": "cbox", "reducer": "uniqueValues", "alias": "Containers" }
        ]
      }
    },
    {
      "id": "organize",
      "options": {
        "renameByName": {
          "pod": "Name",
          "namespace": "Namespace"
        },
        "excludeByName": {
          "endpoint": true,
          "host_ip": true,
          "host_network": true,
          "instance": true,
          "job": true,
          "kubernetes_node": true,
          "uid": true,
          "priority_class": true,
          "pod_key": true,
          "namespace 1": true,
          "namespace 2": true,
          "namespace 3": true,
          "namespace 4": true,
          "Memory (bytes)": true,
          "Memory (MiB)": true,
          "container": true
        },
        "indexByName": {
          "Name": 0,
          "Namespace": 1,
          "Containers": 2,
          "CPU (cores)": 3,
          "Memory": 4,
          "Restarts": 5,
          "Controlled By": 6,
          "Node": 7,
          "Pod IP": 8,
          "Status": 9
        }
      }
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": { "align": "left" }
    },
    "overrides": [
      {
        "matcher": { "id": "byName", "options": "CPU (cores)" },
        "properties": [
          { "id": "unit", "value": "cores" },
          { "id": "decimals", "value": 3 }
        ]
      },
      {
        "matcher": { "id": "byName", "options": "Memory" },
        "properties": [
          { "id": "unit", "value": "bytes" }
        ]
      },
      {
        "matcher": { "id": "byName", "options": "Restarts" },
        "properties": [
          { "id": "decimals", "value": 0 }
        ]
      }
    ]
  },
  "options": {
    "showHeader": true,
    "cellHeight": "sm",
    "sortBy": [
      { "displayName": "CPU (cores)", "desc": true }
    ]
  }
}
